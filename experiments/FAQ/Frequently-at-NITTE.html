<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Frequently Asked Questions by Meghna</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --neo-bg: #e9eef6;
      --neo-surface: #eff4fb;
      --neo-dark: #c9d4e3;
      --neo-accent: #4f6bd8;
      --neo-text:#1c2430;
    }
    html, body { background: var(--neo-bg); color: var(--neo-text); }
    .neo-wrap { max-width: 1200px; }

    /* Neumorphism */
    .neo {
      background: var(--neo-surface);
      border-radius: 18px;
      box-shadow:
        8px 8px 20px rgba(61,86,136,0.18),
        -8px -8px 18px rgba(255,255,255,0.9);
    }
    .neo-inset {
      box-shadow:
        inset 8px 8px 16px rgba(61,86,136,0.15),
        inset -8px -8px 16px rgba(255,255,255,0.9);
    }
    .neo-pill {
      border-radius: 999px;
      background: var(--neo-surface);
      box-shadow:
        6px 6px 14px rgba(61,86,136,0.15),
        -6px -6px 12px rgba(255,255,255,0.9);
    }

    /* Header */
    .app-title{
      letter-spacing:.2px;
      font-weight:800;
      color:#33415c;
    }
    .subtle{
      color:#5e6b84;
    }
    /* Cards and lists */
    .q-card{ transition: transform .06s ease; }
    .q-card:hover{ transform: translateY(-2px); }
    .topic-header{
      cursor:pointer;
      user-select:none;
    }
    .badge-ghost{
      background:transparent;
      border:1px solid #d5deea;
      color:#34465e;
    }
    .tiny{ font-size:.85rem; }
    .sticky-topbar{
      position: sticky; top: 0; z-index: 1030;
      backdrop-filter: blur(6px);
    }
    .tab-btn{ border:none; background:transparent; }
    .tab-btn.active{
      color: var(--neo-accent) !important;
      font-weight:700;
      text-shadow: 0 1px 0 #fff;
    }
    .search-input::placeholder{ color:#8a9ab7; }
    .checkmark{
      inline-size: 1.25rem; block-size: 1.25rem;
    }
    .small-muted{ color:#7a8aa6; font-size:.92rem; }
    .divider{ height:1px; background:linear-gradient(90deg, transparent, #d9e3f2, transparent); }
    .soft-btn{
      border:none; padding:.55rem .85rem;
      border-radius:12px;
      background:var(--neo-surface);
      box-shadow:
        6px 6px 12px rgba(61,86,136,0.12),
        -6px -6px 12px rgba(255,255,255,0.95);
    }
    .soft-btn:hover{ filter:brightness(0.98); }
    a, .link-like{ color: var(--neo-accent); text-decoration: none; }
    .link-like:hover{ text-decoration: underline; }

    /* Mobile tweaks */
    @media (max-width: 576px){
      .app-title{ font-size:1.35rem; }
      .neo { border-radius:16px; }
    }
  </style>
</head>
<body>
  <div id="root" class="container-fluid px-3 px-md-4 px-xl-5 py-3 py-md-4">
    <!-- React mounts here -->
  </div>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="text/babel">
  const {useEffect,useMemo,useState} = React;

  // ---------- helpers ----------
  const STORAGE_KEY = "meghna-faq-checks-v1";

  const loadChecks = () => {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch(e){ return {}; }
  };
  const saveChecks = (obj) => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj||{}));
  };

  const normalizeData = (raw) => {
    // Convert object of questions to array with computed fields
    return Object.entries(raw).map(([id, q]) => {
      const appearances = q.appeared_in_exam || [];
      const times = appearances.length;
      const totalMarks = appearances.reduce((s,a)=>s + (+a.marks||0), 0);
      const markSet = [...new Set(appearances.map(a=>a.marks))].sort((a,b)=>a-b);
      const mostCommonMark = (() => {
        const sorted = Object.entries(c).sort((x, y) => y[1] - x[1] || y[0] - x[0]);
        const topEntry = sorted.length ? sorted[0][0] : 0;
        return Number(topEntry || 0);
      })();
      return {
        id,
        ...q,
        times,
        totalMarks,
        marksPerAppearance: appearances.map(a=>a.marks),
        uniqueMarks: markSet,
        mostCommonMark,
      };
    });
  };

  const groupBy = (arr, getKey) => {
    const m = new Map();
    arr.forEach(item=>{
      const key = getKey(item);
      if(!m.has(key)) m.set(key, []);
      m.get(key).push(item);
    });
    return m;
  };

  // ---------- UI bits ----------
  const Header = ({subjects, subject, setSubject, counts, clearChecks}) => {
    return (
      <div className="sticky-topbar mb-3">
        <div className="neo neo-inset p-3 p-md-4 rounded-4">
          <div className="d-flex flex-column flex-md-row align-items-md-center gap-3">
            <div className="flex-grow-1">
              <h1 className="app-title mb-1">Frequently Asked Questions <span className="subtle">by Meghna</span></h1>
              <div className="small-muted">
                <i className="fa-regular fa-circle-question me-1"></i>
                {counts.filtered} questions • {counts.subjects} subjects • {counts.totalAppearances} appearances
              </div>
            </div>
            <div className="d-flex align-items-center gap-2 ms-md-auto">
              <div className="neo-pill px-3 py-2">
                <div className="d-flex align-items-center gap-2">
                  <i className="fa-solid fa-book-open subtle"></i>
                  <select className="form-select form-select-sm border-0 bg-transparent"
                          value={subject}
                          onChange={e=>setSubject(e.target.value)}>
                    <option value="__ALL__">All subjects</option>
                    {subjects.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              </div>
              <button className="soft-btn tiny" onClick={clearChecks} title="Clear all selections">
                <i className="fa-solid fa-broom me-1"></i>Clear ticks
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const Tabs = ({active, setActive}) => {
    const items = [
      {key:"popular", label:"Popular Questions", icon:"fa-fire"},
      {key:"topics",  label:"Popular Topics",   icon:"fa-list-tree"},
      {key:"all",     label:"All Questions",    icon:"fa-table-list"},
      {key:"picks",   label:"My Picks",         icon:"fa-star"}
    ];
    return (
      <div className="neo p-2 p-md-3 rounded-4 mb-3">
        <ul className="nav nav-pills flex-wrap gap-1">
          {items.map(it=>(
            <li className="nav-item" key={it.key}>
              <button
                className={"tab-btn nav-link neo-pill px-3 py-2 " + (active===it.key ? "active" : "")}
                onClick={()=>setActive(it.key)}
              >
                <i className={`fa-solid ${it.icon} me-2`}></i>{it.label}
              </button>
            </li>
          ))}
        </ul>
      </div>
    );
  };

  const QuestionRow = ({q, checked, onToggle}) => {
    return (
      <div className="q-card neo p-3 rounded-4 mb-2">
        <div className="d-flex align-items-start gap-3">
          <input type="checkbox" className="form-check-input mt-1 checkmark"
            checked={!!checked} onChange={()=>onToggle(q.id)} />
          <div className="flex-grow-1">
            <div className="fw-semibold">{q.question_text}</div>
            <div className="small-muted mt-1 d-flex flex-wrap gap-2">
              <span className="badge badge-ghost rounded-pill">Type: {q.type_of_question}</span>
              <span className="badge badge-ghost rounded-pill">Topic: {q.main_question_topic}</span>
              <span className="badge badge-ghost rounded-pill">Subject: {q.exam_subject}</span>
              <span className="badge badge-ghost rounded-pill">Times: {q.times}</span>
              <span className="badge badge-ghost rounded-pill">Marks: {q.uniqueMarks.join(", ")||"—"}</span>
              <span className="badge badge-ghost rounded-pill">Total marks asked: {q.totalMarks}</span>
            </div>
            <div className="tiny mt-2">
            {(q.appeared_in_exam || []).map((a, i) => (
              <span key={i} className="me-2 text-nowrap">
                <i className="fa-regular fa-calendar me-1"></i>
                {a.exam_month} {a.exam_year} • {a.marks} marks
              </span>
            ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const PopularByMarks = ({questions, checks, onToggle}) => {
    // group by each mark value; if a question has multiple marks, include it in each group
    const buckets = {};
    questions.forEach(q=>{
      (q.uniqueMarks.length ? q.uniqueMarks : [0]).forEach(m=>{
        if(!buckets[m]) buckets[m] = [];
        buckets[m].push(q);
      });
    });

    const markKeys = Object.keys(buckets).map(Number).sort((a,b)=>a-b);

    return (
      <div>
        {markKeys.map(m=> {
          const list = buckets[m]
            .slice()
            .sort((a,b)=> b.times - a.times || b.totalMarks - a.totalMarks);
          return (
            <div key={m} className="mb-4">
              <div className="d-flex align-items-center justify-content-between mb-2">
                <h5 className="mb-0">
                  <span className="neo-pill px-3 py-2 me-2"><i className="fa-solid fa-scale-balanced me-2"></i>{m} marks</span>
                </h5>
                <span className="small-muted">{list.length} questions</span>
              </div>
              {list.map(q=>(
                <QuestionRow key={q.id} q={q} checked={checks[q.id]} onToggle={onToggle}/>
              ))}
            </div>
          );
        })}
      </div>
    );
  };

  const PopularTopics = ({questions, checks, onToggle}) => {
    // topic -> {totalMarks, items[]}
    const topicMap = {};
    questions.forEach(q=>{
      const t = q.main_question_topic || "Misc";
      if(!topicMap[t]) topicMap[t] = {totalMarks:0, items:[]};
      topicMap[t].totalMarks += q.totalMarks;
      topicMap[t].items.push(q);
    });
    const orderedTopics = Object.entries(topicMap)
      .map(([topic, obj]) => ({topic, ...obj}))
      .sort((a,b)=> b.totalMarks - a.totalMarks || a.topic.localeCompare(b.topic));

    const [open, setOpen] = useState({});

    return (
      <div className="accordion" id="topics">
        {orderedTopics.map((t, idx)=> {
          const items = t.items.slice().sort((a,b)=> b.times - a.times || b.totalMarks - a.totalMarks);
          const isOpen = !!open[idx];
          return (
            <div className="mb-3" key={idx}>
              <div className="neo p-3 rounded-4 topic-header d-flex align-items-center justify-content-between"
                   onClick={()=>setOpen(o=>({...o, [idx]:!o[idx]}))}>
                <div className="d-flex align-items-center gap-3">
                  <i className={"fa-solid " + (isOpen? "fa-chevron-down":"fa-chevron-right")}></i>
                  <div>
                    <div className="fw-semibold">{t.topic}</div>
                    <div className="small-muted">
                      <span className="me-3"><i className="fa-solid fa-layer-group me-1"></i>{items.length} questions</span>
                      <span><i className="fa-solid fa-sack-dollar me-1"></i>Aggregate marks: {t.totalMarks}</span>
                    </div>
                  </div>
                </div>
                <span className="badge badge-ghost rounded-pill">Tap to {isOpen?"collapse":"expand"}</span>
              </div>
              {isOpen && (
                <div className="mt-2">
                  {items.map(q=>(
                    <QuestionRow key={q.id} q={q} checked={checks[q.id]} onToggle={onToggle}/>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
    );
  };

  const AllQuestions = ({questions, checks, onToggle}) => {
    const ordered = questions.slice()
      .sort((a,b)=> (b.mostCommonMark - a.mostCommonMark) || (b.totalMarks - a.totalMarks) || (b.times - a.times));
    return (
      <div>
        {ordered.map(q => (
          <QuestionRow key={q.id} q={q} checked={checks[q.id]} onToggle={onToggle}/>
        ))}
      </div>
    );
  };

  const Picks = ({questions, checks, onToggle}) => {
    const picked = questions.filter(q=> !!checks[q.id]);
    if(!picked.length){
      return (
        <div className="neo p-4 rounded-4 text-center">
          <div className="display-6 mb-2">✨</div>
          <div className="fw-semibold">No picks yet</div>
          <div className="small-muted">Tick the checkbox next to any question to add it here. Your selection is saved on this device.</div>
        </div>
      );
    }
    return (
      <div>
        {picked.map(q=>(
          <QuestionRow key={q.id} q={q} checked={checks[q.id]} onToggle={onToggle}/>
        ))}
      </div>
    );
  };

  // ---------- Main App ----------
  const App = () => {
    const [data, setData] = useState(null);
    const [subject, setSubject] = useState("__ALL__");
    const [active, setActive] = useState("popular");
    const [checks, setChecks] = useState(loadChecks());
    const [error, setError] = useState("");

    useEffect(()=>{
      (async ()=>{
        try{
          const res = await fetch("dataset3.json", {cache:"no-store"});
          if(!res.ok) throw new Error("Could not load dataset3.json");
          const json = await res.json();
          setData(normalizeData(json));
        }catch(e){
          setError(e.message || "Failed to load dataset");
        }
      })();
    },[]);

    useEffect(()=>{ saveChecks(checks); }, [checks]);

    const subjects = useMemo(()=>{
      if(!data) return [];
      return [...new Set(data.map(d=>d.exam_subject))].sort();
    },[data]);

    const filtered = useMemo(()=>{
      if(!data) return [];
      return data.filter(d => subject==="__ALL__" ? true : d.exam_subject===subject);
    },[data, subject]);

    const counts = useMemo(()=>{
      const totalAppearances = filtered.reduce((s,q)=> s + q.times, 0);
      return {filtered: filtered.length, subjects: subjects.length, totalAppearances};
    },[filtered, subjects]);

    const toggleCheck = (id) => setChecks(prev => ({...prev, [id]: !prev[id]}));
    const clearChecks = () => { setChecks({}); localStorage.removeItem(STORAGE_KEY); };

    if(error){
      return (
        <div className="neo-wrap mx-auto">
          <div className="neo p-4 rounded-4 mt-3">
            <h2 className="app-title mb-2">Frequently Asked Questions <span className="subtle">by Meghna</span></h2>
            <div className="alert alert-danger"><i className="fa-solid fa-triangle-exclamation me-2"></i>{error}</div>
            <p className="small-muted">Place <code>dataset3.json</code> in the same folder as this HTML file and reload.</p>
          </div>
        </div>
      );
    }

    if(!data){
      return (
        <div className="neo-wrap mx-auto">
          <div className="neo p-4 rounded-4 mt-3 text-center">
            <div className="spinner-border me-2" role="status"></div>
            Loading questions…
          </div>
        </div>
      );
    }

    return (
      <div className="neo-wrap mx-auto">
        <Header
          subjects={subjects}
          subject={subject}
          setSubject={setSubject}
          counts={counts}
          clearChecks={clearChecks}
        />
        <Tabs active={active} setActive={setActive}/>
        <div className="mb-5">
          {active==="popular" && <PopularByMarks questions={filtered} checks={checks} onToggle={toggleCheck}/>}
          {active==="topics"  && <PopularTopics   questions={filtered} checks={checks} onToggle={toggleCheck}/>}
          {active==="all"     && <AllQuestions   questions={filtered} checks={checks} onToggle={toggleCheck}/>}
          {active==="picks"   && <Picks          questions={filtered} checks={checks} onToggle={toggleCheck}/>}
        </div>
        <footer className="text-center small-muted mt-4 mb-3">
          <div className="divider mb-3"></div>
          <span className="me-2">Built with React + Bootstrap • Neumorphic UI</span>
          <span className="d-inline-block ms-2">© {new Date().getFullYear()} Meghna</span>
        </footer>
      </div>
    );
  };

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
